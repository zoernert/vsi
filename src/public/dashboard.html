<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - VSI Vector Store</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header class="dashboard-header">
            <h1>VSI Dashboard</h1>
            <div class="user-info">
                <span id="username-display"></span>
                <span id="admin-badge" class="admin-badge" style="display: none;">ADMIN</span>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Admin Panel -->
            <div id="admin-panel" class="card" style="display: none;">
                <h3>üë®‚Äçüíº Admin Panel</h3>
                
                <div class="admin-section">
                    <h4>Create User</h4>
                    <div class="admin-controls">
                        <input type="text" id="admin-new-username" placeholder="Username">
                        <input type="password" id="admin-new-password" placeholder="Password">
                        <label class="checkbox-label">
                            <input type="checkbox" id="admin-new-isadmin"> Admin User
                        </label>
                        <button onclick="createUser()" class="btn btn-primary">Create User</button>
                    </div>
                </div>
                
                <div class="admin-section">
                    <h4>User Management</h4>
                    <button onclick="loadUsers()" class="btn btn-secondary">Refresh Users</button>
                    <div id="users-list"></div>
                </div>
                
                <div class="admin-section">
                    <h4>System Status</h4>
                    <div id="system-status">
                        <p><strong>Self Registration:</strong> <span id="self-reg-status">-</span></p>
                        <p><strong>RapidAPI Support:</strong> <span id="rapidapi-status">-</span></p>
                    </div>
                </div>
            </div>

            <!-- LLM Q&A Section -->
            <div class="card">
                <h3>ü§ñ LLM Question & Answer</h3>
                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">Ask questions about your documents and get AI-powered answers with context.</p>
                
                <div class="qa-section">
                    <div class="qa-form">
                        <div style="margin-bottom: 10px;">
                            <label for="qa-question">Question:</label>
                            <textarea id="qa-question" placeholder="Enter your question here..." rows="3" style="resize: vertical;"></textarea>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="qa-collection-select">Collection:</label>
                            <select id="qa-collection-select">
                                <option value="">Select a collection...</option>
                            </select>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label for="qa-system-prompt">System Prompt (optional):</label>
                            <textarea id="qa-system-prompt" placeholder="Custom instructions for the AI assistant..." rows="2"></textarea>
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label for="qa-max-results">Max Results:</label>
                            <input type="number" id="qa-max-results" value="5" min="1" max="20" style="width: 80px;">
                        </div>
                        <button onclick="askQuestion()" class="btn btn-primary">Ask Question</button>
                    </div>
                    <div id="qa-results" style="margin-top: 15px;"></div>
                </div>
            </div>

            <!-- API Key Section -->
            <div class="card">
                <h3>API Access</h3>
                <div class="api-key-section">
                    <label>Your Bearer Token:</label>
                    <div class="api-key-display">
                        <input type="text" id="api-key" readonly>
                        <button onclick="copyApiKey()" class="btn btn-small">Copy</button>
                    </div>
                </div>
                
                <div class="usage-info">
                    <h4>HTTP Client Examples:</h4>
                    <pre><code id="http-examples">// Using fetch
fetch('${window.location.origin}/collections', {
  headers: {
    'Authorization': 'Bearer your-token-here'
  }
});

// Using axios
axios.get('${window.location.origin}/collections', {
  headers: {
    'Authorization': 'Bearer your-token-here'
  }
});</code></pre>

                    <h4>Qdrant-Compatible API:</h4>
                    <p>Use standard Qdrant operations with authentication:</p>
                    <pre><code id="qdrant-examples"># List collections
curl -X GET "${window.location.origin}/collections" \
  -H "Authorization: Bearer your-token-here"

# Create collection
curl -X PUT "${window.location.origin}/collections/my_docs" \
  -H "Authorization: Bearer your-token-here" \
  -H "Content-Type: application/json" \
  -d '{"vectors":{"size":768,"distance":"Cosine"}}'

# Search vectors
curl -X POST "${window.location.origin}/collections/my_docs/points/search" \
  -H "Authorization: Bearer your-token-here" \
  -H "Content-Type: application/json" \
  -d '{"vector":[0.1,0.2,0.3],"limit":5,"with_payload":true}'

# Upsert points
curl -X PUT "${window.location.origin}/collections/my_docs/points" \
  -H "Authorization: Bearer your-token-here" \
  -H "Content-Type: application/json" \
  -d '{"points":[{"id":"doc1","vector":[0.1,0.2,0.3],"payload":{"text":"Hello"}}]}'</code></pre>

                    <h4>VSI-Specific API:</h4>
                    <p>Enhanced features for document management:</p>
                    <pre><code id="vsi-examples"># Upload file
curl -X POST "${window.location.origin}/api/collections/my_docs/upload" \
  -H "Authorization: Bearer your-token-here" \
  -F "file=@document.txt"

# Create text document
curl -X POST "${window.location.origin}/api/collections/my_docs/create-text" \
  -H "Authorization: Bearer your-token-here" \
  -H "Content-Type: application/json" \
  -d '{"title":"My Note","content":"This is my document content"}'

# Semantic search
curl -X POST "${window.location.origin}/api/collections/my_docs/search" \
  -H "Authorization: Bearer your-token-here" \
  -H "Content-Type: application/json" \
  -d '{"query":"machine learning","limit":10}'

# List documents
curl -X GET "${window.location.origin}/api/collections/my_docs/documents" \
  -H "Authorization: Bearer your-token-here"</code></pre>
                    
                    <div style="margin-top: 15px;">
                        <a href="/openapi.json" target="_blank" class="btn btn-small btn-secondary">üìã API Documentation</a>
                        <a href="https://github.com/your-repo/vsi" target="_blank" class="btn btn-small btn-secondary">üìñ README</a>
                    </div>
                </div>
            </div>

            <!-- Collections Section -->
            <div class="card">
                <h3>Collections</h3>
                <div class="collection-controls">
                    <input type="text" id="new-collection-name" placeholder="Collection name">
                    <button onclick="createCollection()" class="btn btn-primary">Create</button>
                    <button onclick="loadCollections()" class="btn btn-secondary">Refresh</button>
                </div>
                <div id="collections-list"></div>
            </div>

            <!-- File Upload Section -->
            <div class="card">
                <h3>Upload Files</h3>
                <div class="upload-section">
                    <select id="upload-collection">
                        <option value="">Select collection...</option>
                    </select>
                    <input type="file" id="file-input" multiple 
                           accept=".txt,.md,.pdf,.docx,.doc,.xlsx,.xls,.jpg,.jpeg,.png,.gif,.bmp,.webp">
                    <button onclick="uploadFiles()" class="btn btn-primary">Upload & Index</button>
                </div>
                <div id="upload-progress"></div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px;">
                    <strong>üì• Supported File Types:</strong>
                    <ul style="margin: 5px 0; padding-left: 20px;">
                        <li><strong>Documents:</strong> PDF, Word (.docx), Excel (.xlsx, .xls), Text (.txt), Markdown (.md)</li>
                        <li><strong>Images:</strong> JPEG, PNG, GIF, BMP, WebP (with AI description generation)</li>
                    </ul>
                    <strong>üì• File Downloads:</strong> Uploaded files can be downloaded using their UUID (no authentication required).
                    Each uploaded file gets a unique download URL that you can share.
                </div>
            </div>

            <!-- Text Creation Section -->
            <div class="card">
                <h3>Create Text Document</h3>
                <div class="text-creation">
                    <select id="text-collection">
                        <option value="">Select collection...</option>
                    </select>
                    <input type="text" id="text-title" placeholder="Document title">
                    <textarea id="text-content" placeholder="Enter your text content here..." rows="6"></textarea>
                    <button onclick="createTextDocument()" class="btn btn-primary">Create & Index</button>
                </div>
            </div>

            <!-- Search Section -->
            <div class="card">
                <h3>Search Documents</h3>
                <div class="search-section">
                    <select id="search-collection">
                        <option value="">Select collection...</option>
                    </select>
                    <input type="text" id="search-query" placeholder="Enter your search query...">
                    <button onclick="searchDocuments()" class="btn btn-primary">Search</button>
                </div>
                <div id="search-results"></div>
            </div>

            <!-- Document Browser Section -->
            <div class="card">
                <h3>Document Browser</h3>
                <div class="browser-section">
                    <select id="browse-collection">
                        <option value="">Select collection...</option>
                    </select>
                    <button onclick="browseDocuments()" class="btn btn-secondary">Browse All</button>
                </div>
                <div id="browse-results"></div>
            </div>

        </div>
    </div>

    <script src="dashboard.js"></script>
    <script>
        // Global variable for base URL
        let BASE_URL = window.location.origin; // Fallback

        // Fetch base URL from settings API
        async function loadBaseUrl() {
            try {
                const response = await fetch('/api/settings', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                if (response.ok) {
                    const settings = await response.json();
                    if (settings.BASE_URL) {
                        BASE_URL = settings.BASE_URL;
                    }
                }
            } catch (error) {
                console.warn('Failed to load base URL setting:', error);
            }
        }

        // LLM Q&A Functions
        async function askQuestion() {
            const question = document.getElementById('qa-question').value.trim();
            const collectionName = document.getElementById('qa-collection-select').value;
            const systemPrompt = document.getElementById('qa-system-prompt').value.trim();
            const maxResults = parseInt(document.getElementById('qa-max-results').value);

            if (!question || !collectionName) {
                alert('Please provide both question and collection name');
                return;
            }

            const resultsDiv = document.getElementById('qa-results');
            resultsDiv.innerHTML = '<div style="text-align: center; padding: 15px; color: #666; font-style: italic;">ü§î Processing your question...</div>';

            try {
                const requestBody = {
                    question,
                    maxResults
                };

                if (systemPrompt) {
                    requestBody.systemPrompt = systemPrompt;
                }

                const token = localStorage.getItem('token');
                const headers = {
                    'Content-Type': 'application/json',
                };

                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }

                const response = await fetch(`/api/collections/${encodeURIComponent(collectionName)}/ask`, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.message || 'Failed to get answer');
                }

                displayQAResults(data);
            } catch (error) {
                resultsDiv.innerHTML = `<div style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; border-left: 4px solid #dc3545;">‚ùå Error: ${error.message}</div>`;
            }
        }

        function displayQAResults(data) {
            const resultsDiv = document.getElementById('qa-results');
            
            const html = `
                <div style="background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px;">
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 4px; margin-bottom: 15px; border-left: 4px solid #28a745;">
                        <h4 style="margin: 0 0 10px 0;">üí° Answer:</h4>
                        <p style="margin: 0; white-space: pre-wrap;">${escapeHtml(data.answer)}</p>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 0.9em;">
                        <h5 style="margin: 0 0 8px 0; color: #495057;">üîç Query Variations Used (${data.queries.length}):</h5>
                        <ul style="margin: 0; padding-left: 20px;">
                            ${data.queries.map(query => `<li style="margin-bottom: 4px;">${escapeHtml(query)}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 10px; border-radius: 4px; font-size: 0.9em;">
                        <h5 style="margin: 0 0 8px 0; color: #495057;">üìÑ Retrieved Context (${data.retrievedContext.length} chunks):</h5>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${data.retrievedContext.map(context => formatContextSource(context)).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
        }

        function formatContextSource(context) {
            // Check if this context looks like it's from a file (contains download URL pattern)
            const fileUrlMatch = context.match(/\/api\/files\/([a-f0-9-]{36})/);
            const filenameMatch = context.match(/Document: (.+?)(?:\.|$)/);
            
            if (fileUrlMatch && filenameMatch) {
                const fileUuid = fileUrlMatch[1];
                const filename = filenameMatch[1];
                const downloadUrl = `${BASE_URL}/api/files/${fileUuid}`;
                const truncated = context.length > 150 ? context.substring(0, 150) + '...' : context;
                
                return `
                    <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #007bff;">
                        <div style="font-weight: bold; margin-bottom: 4px;">
                            üìé <a href="${downloadUrl}" target="_blank" style="color: #007bff; text-decoration: none;">${escapeHtml(filename)}</a>
                            <span style="font-size: 0.8em; color: #666; margin-left: 8px;">
                                <a href="${downloadUrl}" target="_blank" style="color: #666;">‚Üó Download</a>
                            </span>
                        </div>
                        <div style="font-size: 0.9em; color: #666;">${escapeHtml(truncated)}</div>
                    </div>
                `;
            } else {
                // Regular text context
                const truncated = context.length > 150 ? context.substring(0, 150) + '...' : context;
                return `
                    <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                        <div style="font-size: 0.9em;">${escapeHtml(truncated)}</div>
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Update the existing loadCollections function to also load base URL
        const originalLoadCollections = loadCollections;
        loadCollections = async function() {
            // Load base URL first
            await loadBaseUrl();
            
            await originalLoadCollections();
            
            // Also update Q&A dropdown
            try {
                const response = await fetch('/collections', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                
                const qaSelect = document.getElementById('qa-collection-select');
                if (qaSelect) {
                    qaSelect.innerHTML = '<option value="">Select a collection...</option>';
                    data.collections.forEach(collection => {
                        const option = document.createElement('option');
                        option.value = collection.name;
                        option.textContent = collection.name;
                        qaSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load collections for Q&A:', error);
            }
        };

        // Load base URL on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadBaseUrl();
        });
    </script>
</body>
</html>
